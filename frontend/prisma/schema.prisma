generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. AUTENTICAÇÃO E PERFIS
model Usuario {
  id              String  @id @default(uuid())
  nome            String
  email           String  @unique
  senha           String
  perfil          Perfil
  empresaPadraoId String? @map("empresa_padrao_id")
  unidadePadraoId String? @map("unidade_padrao_id")
  ativo           Boolean @default(true)

  empresaPadrao      Empresa?            @relation(fields: [empresaPadraoId], references: [id])
  unidadePadrao      Unidade?            @relation(fields: [unidadePadraoId], references: [id])
  trocarSenha        Boolean             @default(true) @map("trocar_senha")
  area               Area                @default(GERAL)
  checklistRespostas ChecklistResposta[]

  @@map("usuarios")
}

enum Perfil {
  ADMIN
  GESTOR
  PCM
  SEGURANCA
  ESTOQUE
  CUSTO
  RH
  OPERACIONAL
}

enum Area {
  GERAL
  PCM
  FROTA
  COLHEITA
  SILVICULTURA
  CARREGAMENTO
  ALMOXARIFADO
  RH
  FINANCEIRO
  SEGURANCA
}

// 2. CADASTROS BASE
model Empresa {
  id           String  @id @default(uuid())
  nomeFantasia String  @map("nome_fantasia")
  razaoSocial  String  @map("razao_social")
  cnpj         String  @unique
  ativo        Boolean @default(true)

  unidades Unidade[]
  veiculos Veiculo[]
  usuarios Usuario[]

  @@map("empresas")
}

model Unidade {
  id          String  @id @default(uuid())
  nomeUnidade String  @map("nome_unidade")
  empresaId   String  @map("empresa_id")
  cidade      String
  estado      String
  ativo       Boolean @default(true)

  empresa  Empresa   @relation(fields: [empresaId], references: [id])
  veiculos Veiculo[]
  usuarios Usuario[]

  @@map("unidades")
}

model Veiculo {
  id                       String            @id @default(uuid())
  codigoInterno            String            @unique @map("codigo_interno")
  placa                    String?
  tipoVeiculo              String            @map("tipo_veiculo")
  fabricante               String
  modelo                   String
  ano                      Int
  empresaId                String            @map("empresa_id")
  unidadeId                String            @map("unidade_id")
  status                   StatusOperacional @map("status_operacional")
  kmAtual                  Int               @default(0) @map("km_atual")
  horimetroAtual           Int               @default(0) @map("horimetro_atual")
  critico                  Boolean           @default(false)
  observacoes              String?
  categoria                String?
  moduloSistema            String?           @map("modulo_sistema")
  dataAtualizacaoHorimetro DateTime?         @map("data_atualizacao_horimetro")
  semanaPreventiva         Int?              @map("semana_preventiva")

  // Dados da Programação Semanal
  programacaoStatus     String?   @default("PENDENTE") @map("prog_status")
  programacaoProgresso  Int?      @default(0) @map("prog_progresso")
  programacaoModulo     String?   @map("prog_modulo")
  programacaoDescricao  String?   @map("prog_descricao")
  programacaoDataInicio DateTime? @map("prog_data_inicio")
  programacaoDataFim    DateTime? @map("prog_data_fim")

  empresa            Empresa             @relation(fields: [empresaId], references: [id])
  unidade            Unidade             @relation(fields: [unidadeId], references: [id])
  os                 OrdemServico[]
  planos             PlanoManutencao[]
  pneus              Pneu[]
  boletinsPneu       BoletimPneu[]
  documentos         DocumentoFrota[]
  checklistRespostas ChecklistResposta[]

  @@index([unidadeId])
  @@map("veiculos_frota")
}

enum StatusOperacional {
  DISPONIVEL
  EM_OPERACAO
  EM_MANUTENCAO
  PARADO
  DESATIVADO
}

// 4. MÓDULO PCM
model OrdemServico {
  id             String    @id @default(uuid())
  numeroOS       Int       @default(autoincrement()) @map("numero_os")
  veiculoId      String    @map("veiculo_id")
  tipoOS         TipoOS    @map("tipo_os")
  origem         String?
  descricao      String
  dataAbertura   DateTime  @default(now()) @map("data_abertura")
  dataPlanejada  DateTime? @map("data_planejada")
  dataInicio     DateTime? @map("data_inicio")
  dataConclusao  DateTime? @map("data_conclusao")
  status         StatusOS  @map("status_os")
  tempoParada    Float?    @map("tempo_parada_horas")
  responsavelPcm String?   @map("responsavel_pcm")

  // Parâmetros Mestre
  motivoId     String? @map("motivo_id")
  sistemaId    String? @map("sistema_id")
  subSistemaId String? @map("sub_sistema_id")

  veiculo    Veiculo       @relation(fields: [veiculoId], references: [id])
  motivo     OsMotivo?     @relation(fields: [motivoId], references: [id])
  sistema    OsSistema?    @relation(fields: [sistemaId], references: [id])
  subSistema OsSubSistema? @relation(fields: [subSistemaId], references: [id])

  @@index([status])
  @@index([tipoOS])
  @@index([dataAbertura])
  @@map("ordens_servico")
}

enum TipoOS {
  PREVENTIVA
  CORRETIVA
  INSPECAO
  MELHORIA
}

enum StatusOS {
  ABERTA
  PLANEJADA
  EM_EXECUCAO
  CONCLUIDA
}

model PlanoManutencao {
  id              String           @id @default(uuid())
  veiculoId       String           @map("veiculo")
  tipo            String           @map("tipo_manutencao") // Ex: Motor, Hidraulico (No form: Tipo)
  modulo          String? // No form: Módulo
  ultimoHorimetro Int              @default(0) @map("ultimo_horimetro") // No form: Último Horímetro
  intervalo       Int              @map("intervalo_horas") // No form: Intervalo
  dataAtualizacao DateTime         @default(now()) @map("data_atualizacao") // No form: Data da Atualização
  status          StatusPreventiva @default(NO_PRAZO) @map("status_preventiva")

  veiculo Veiculo @relation(fields: [veiculoId], references: [id])

  @@map("planos_manutencao")
}

enum TipoGatilho {
  KM
  HORAS
  DIAS
}

enum StatusPreventiva {
  NO_PRAZO
  ATENCAO
  ATRASADO
}

model Pneu {
  id             String  @id @default(uuid())
  codigoPneu     String  @unique @map("codigo_pneu")
  medida         String
  vida           Int     @default(1) // 1ª vida, 2ª vida...
  status         String
  veiculoAtualId String? @map("veiculo_atual")
  posicao        String?
  sulcoAtualMm   Float   @map("sulco_atual_mm")

  veiculo           Veiculo?          @relation(fields: [veiculoAtualId], references: [id])
  historicoInspecao ItemBoletimPneu[]

  @@map("pneus_frota")
}

model SystemParameters {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  group       String   @default("GERAL") // GERAL, NOTIFICACAO, INTEGRACAO, ETC
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_parameters")
}

model OsMotivo {
  id    String         @id @default(uuid())
  nome  String         @unique
  ativo Boolean        @default(true)
  os    OrdemServico[]

  @@map("os_motivos")
}

model OsSistema {
  id          String         @id @default(uuid())
  nome        String         @unique
  ativo       Boolean        @default(true)
  subSistemas OsSubSistema[]
  os          OrdemServico[]

  @@map("os_sistemas")
}

model OsSubSistema {
  id        String  @id @default(uuid())
  nome      String
  sistemaId String  @map("sistema_id")
  ativo     Boolean @default(true)

  sistema OsSistema      @relation(fields: [sistemaId], references: [id])
  os      OrdemServico[]

  @@unique([nome, sistemaId])
  @@map("os_sub_sistemas")
}

model BoletimPneu {
  id          String   @id @default(uuid())
  veiculoId   String   @map("veiculo_id")
  data        DateTime
  km          Int
  condicao    String?
  observacoes String?
  criadoEm    DateTime @default(now()) @map("criado_em")

  itens   ItemBoletimPneu[]
  veiculo Veiculo           @relation(fields: [veiculoId], references: [id])

  @@map("boletins_pneu")
}

model ItemBoletimPneu {
  id        String  @id @default(uuid())
  boletimId String  @map("boletim_id")
  posicao   String
  sulcoMm   Float   @map("sulco_mm")
  pneuId    String? @map("pneu_id")

  boletim BoletimPneu @relation(fields: [boletimId], references: [id])
  pneu    Pneu?       @relation(fields: [pneuId], references: [id])

  @@map("itens_boletim_pneu")
}

model DocumentoFrota {
  id           String    @id @default(uuid())
  veiculoId    String    @map("veiculo_id")
  tipo         String // LAUDO, CRLV, IMPLEMENTO, TACOGRAFO, CIV_CIPP
  numero       String?
  dataEmissao  DateTime? @map("data_emissao")
  dataValidade DateTime? @map("data_validade")

  veiculo Veiculo @relation(fields: [veiculoId], references: [id])

  @@unique([veiculoId, tipo])
  @@map("documentos_frota")
}

model Backlog {
  id                         String    @id @default(uuid())
  semana                     String?
  mes                        String?
  ano                        String?
  dataEvidencia              DateTime? @map("data_evidencia")
  modulo                     String?
  regiaoProgramacao          String?   @map("regiao_programacao")
  diasPendenciaAberta        Int?      @map("dias_pendencia_aberta")
  frota                      String?
  tag                        String?
  tipo                       String?
  descricaoAtividade         String?   @map("descricao_atividade")
  origem                     String?
  criticidade                String?
  tempoExecucaoPrevisto      String?   @map("tempo_execucao_previsto")
  campoBase                  String?   @map("campo_base")
  os                         String?
  material                   String?
  numeroRc                   String?   @map("numero_rc")
  numeroOrdem                String?   @map("numero_ordem")
  fornecedor                 String?
  dataRc                     DateTime? @map("data_rc")
  detalhamentoPedido         String?   @map("detalhamento_pedido")
  dataNecessidadeMaterial    DateTime? @map("data_necessidade_material")
  tipoPedido                 String?   @map("tipo_pedido")
  previsaoMaterial           DateTime? @map("previsao_material")
  situacaoRc                 String?   @map("situacao_rc")
  diasAberturaReqCompras     Int?      @map("dias_abertura_req_compras")
  dataProgramacao            DateTime? @map("data_programacao")
  maoDeObra                  String?   @map("mao_de_obra")
  deltaEvidenciaProgramacao  Int?      @map("delta_evidencia_programacao")
  statusProgramacao          String?   @map("status_programacao")
  previsaoConclusaoPendencia DateTime? @map("previsao_conclusao_pendencia")
  dataConclusaoPendencia     DateTime? @map("data_conclusao_pendencia")
  diasResolucaoPendencia     Int?      @map("dias_resolucao_pendencia")
  status                     String?
  observacao                 String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("backlog_pcm")
}

// 5. CHECKLISTS PCM
model ChecklistFormulario {
  id        String   @id @default(uuid())
  nome      String
  descricao String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  itens     ChecklistItem[]
  respostas ChecklistResposta[]

  @@map("checklist_formularios")
}

model ChecklistItem {
  id           String  @id @default(uuid())
  formularioId String  @map("formulario_id")
  texto        String
  categoria    String?
  obrigatorio  Boolean @default(true)
  ordem        Int     @default(0)

  formulario    ChecklistFormulario     @relation(fields: [formularioId], references: [id], onDelete: Cascade)
  respostasItem ChecklistItemResposta[]

  @@map("checklist_itens")
}

model ChecklistResposta {
  id           String @id @default(uuid())
  formularioId String @map("formulario_id")
  veiculoId    String @map("veiculo_id")
  usuarioId    String @map("usuario_id")

  dataResposta      DateTime @default(now()) @map("data_resposta")
  observacoesGerais String?  @map("observacoes_gerais")
  assinatura        String?

  formulario ChecklistFormulario @relation(fields: [formularioId], references: [id])
  veiculo    Veiculo             @relation(fields: [veiculoId], references: [id])
  usuario    Usuario             @relation(fields: [usuarioId], references: [id])

  respostasItem ChecklistItemResposta[]

  @@map("checklist_respostas")
}

model ChecklistItemResposta {
  id         String @id @default(uuid())
  respostaId String @map("resposta_id")
  itemId     String @map("item_id")

  status     String  @default("OK")
  observacao String?

  resposta ChecklistResposta @relation(fields: [respostaId], references: [id], onDelete: Cascade)
  item     ChecklistItem     @relation(fields: [itemId], references: [id])

  @@map("checklist_itens_respostas")
}
